{
  "ignition": {
    "version": "3.3.0"
  },
  "kernelArguments": {
    "shouldExist": [
      "mitigations=auto,nosmt",
      "tsx=auto"
    ]
  },
  "passwd": {
    "users": [
      {
        "groups": [
          "sudo"
        ],
        "name": "core",
        "passwordHash": "!",
        "sshAuthorizedKeys": [
          "ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIEYcqyGk3/+jtWv9gN2IxZnNfT3BhV3ljEueCPcxAGH4 ceo@haeicore.com.br"
        ]
      }
    ]
  },
  "storage": {
    "directories": [
      {
        "path": "/var/log/journal",
        "mode": 493
      },
      {
        "path": "/var/lib/nft",
        "mode": 493
      },
      {
        "path": "/etc/ssl/localcerts",
        "mode": 493
      },
      {
        "path": "/etc/systemd/resolved.conf.d",
        "mode": 493
      }
    ],
    "files": [
      {
        "path": "/etc/ssh/sshd_config.d/10-hardening.conf",
        "contents": {
          "compression": "gzip",
          "source": "data:;base64,H4sIAAAAAAAC/1yQwW7bMAyG73oKPUDcxjLkYT3V7bINaLIVTTrsqsiEJdQWDZJO4rcv7AJt3Zv48RP5S49AXZQnRNliE5NOqB4d8xmprgYJkCR6JxHfOsPxBcYvfARWS7QDCViz7odjG/0LjGrnLpNyoAisi6nciyMZetbmpljfWDVv/0XOwyF2oIu1ekv2zECbdIqEqYMkU4oHuFRtgxQldKz9QCcw1ubfMw7O2PK2jUfmcIXUrDgJDf23Mr+8GzY3t9hDmhSPnbqPfQBi7YPzwZl11mM75sXafrZWDtjYMmt8t7i8q+5Zh875eXdmc5OBLJTVR3ca8KWrfiPLA4yf3sMcMqjnuCti9z74ozC2VFXb4rlqIMlPpLOjOqZm+puZH3y/pP/zfAmeGX782U+nLTZbOEGr/22e7v7uN+rOpQSkr0H8dWQe4CqBqNcAAAD//1sRzsQnAgAA"
        },
        "mode": 420
      },
      {
        "path": "/etc/issue.net",
        "contents": {
          "compression": "gzip",
          "source": "data:;base64,H4sIAAAAAAAC/1KmBHApK0CBo7NrcLC/QpBrcEiQZ4i/nkKIv4ujgmOIZ5ini6OLq8LhTgVffz/PEP8gRxdHPYgeZS7KLAcEAAD//5ZcZtW7AAAA"
        },
        "mode": 420
      },
      {
        "path": "/etc/sysctl.d/99-hardening.conf",
        "contents": {
          "compression": "gzip",
          "source": "data:;base64,H4sIAAAAAAAC/4ySQW/iMBCF7/kVSNy9SWBZLr7uZQ8rtT/AGuwJjOLY1syEkn9fBYkCamm5We+9+fQ8muXiBQNWCdVQOa6N+uJkSj7nnlBsc3V8Tp2BGA0X11FU5E9uwA7GqN8k5nnwHos6xkCMXsXWDzCPg5tnaJtnaTfdBFN4otkPsZkU894NwEqQ7tY4L5g736xWf2xTLRf/kBPGX39fq/78Mn1RdoyiTF5te5HDgLK/6s1FH1NhOlLEPQY3CnIS52NOaOsPIp7Qu5ghuEACu4jhOj/BAKYog0cnPhe0bdWJKZwVvWJwB+AQKfXzL+4MmYYbXUYKLoxDmfm2rpaL/ztBPsKOIgUIOIcoZaVuMgOczl3dG6g/oNjf7brdbr+MUBKF5OdjrNt19R4AAP//UcyRqrECAAA="
        },
        "mode": 420
      },
      {
        "path": "/etc/nftables.mgmt-ports.conf",
        "contents": {
          "compression": "gzip",
          "source": "data:;base64,H4sIAAAAAAAC/ySNMQ+CMBBGd37FJSyaMNSywHCTJjo4kOBOGji0YmlzLTHG+N8N3PLyLd97A412JnB3l7rUhy54ThEQvqB1AbWqVQGlUisPKytVbVx3LSx1Cb8sB62xbS9ywoa9o/SgJcofz2xGMxvx4NVPVmR48lN4+U+R5ZsWj+zfQ0s9mBBgZ55LTLSXGDaek7EzsWTxxoZGO4GjxLaP2T8AAP//FFj7M84AAAA="
        },
        "mode": 420
      },
      {
        "path": "/etc/nftables.conf",
        "contents": {
          "compression": "gzip",
          "source": "data:;base64,H4sIAAAAAAAC/3RSS24TQRDdzymezCaR4tiEECGyYQdZBcUIllFPTw1T0N3VdNfEsSyfgiOw4gpsfTE04xmw7GTTatXnvVevqnZtbpBaR5m04GBdWxEmM1I7C7Wa0lE+91+9TqMkzedWQj0p+jg4kKJmp5SwLgDbGA65/wIcYqvDH9BVpLG0Efk+pGNiSawrzK8RxbFdoUoSr4cuq8hqlEC5Y+TcUHWWyBmlCsZaijpUMtdwMsbGYERMomLFga2Pu6eXQraRaaIfLWWFY8+K1BG9nmWyEg7R4xUCPWpTpR7j4eqA6QUWiw+I2z+lYyv4eHf7+Wax/Xl3c4sTo9vf+GTYZWscIbclp9PRFhtRdcbi4uL/tIGW+5pezmeeQ6t0RPqesm5/yVtk8RSU8MBmj+rEU/aCIIiUanYwJSWV0z3PJjpWzyd7at51G79XG+/7rR8Rf6Hy37RHo6zfzM8uL19tDroSfSOrWLI2vYmPu02YynOYxiQNl6xU9dWb/q0lLU2qsD4+nzH13AENCNJqd2ZPIYypJxB2uncYm2JT/A0AAP//E7E34yQDAAA="
        },
        "mode": 420
      },
      {
        "path": "/etc/nftables.closed.conf",
        "contents": {
          "compression": "gzip",
          "source": "data:;base64,H4sIAAAAAAAC/3RSsW7bQAzd9RUP7tICim2gaVAgS4cC6dAhQIaOwfmOqlifjlcelcQw/DX9hG5d/WOFZCkonHQhiEfy8fHeNbEvLbSPVMgqTj72gbBYkflVasxtIpVl972ziyxqZeklNYtqxMGJDA1HI8W+AnzrOJUxBTjl3qYcsF2mubUV2U7lrCzKtsP6Glki+x2CSr6epryhmDMClWEjl5ZCrRSdUYDznrJNncwNoszYDGZkFRMvEey7fAqjFPKtXCj97KkYInds0GHRh1UhL+mcPV8h0ZO1QUeOh6uzTW9wQ8WOvwRv7+6+1LhV6WrcqGtccjW+ypZrfJZtjrKrcStqjhNpDTK/fIdy/I0HdjDHsXgX6Z+rFs/gegHzGWEwAp8GT+7N5/vRlxd6vtEG+fhnE9nL7MHz8P7jur68fH84m1L6Qd7wyNaOZz6d3sqFjtNFVml5w0Zh7D6MsRF9dBqwf2nwXPqfxROD9DZ8hNcY5tIrDCfdJ45Ddaj+BgAA//89YaP5xgIAAA=="
        },
        "mode": 420
      },
      {
        "path": "/etc/nftables.open.conf",
        "contents": {
          "compression": "gzip",
          "source": "data:;base64,H4sIAAAAAAAC/3SR367aMAzG7/sUVq8Ppx1jaBI3exMUHHfxlsZZ4g4Q6rtPTYvG3xvL8uf8/MXu/JAdpMFTJq04oB8sQd2QYhM6NQdP+bP/2esqStL8iRK6uip14EAKHXulBJcKAJ3hkEsKwCEOuuQAeo50bXUivxc5JpbEeoZ2B1E84xlskrhbXqFCVqMElKeJnB3Zj0TeKFkwiBR16WTuwMtDLUJMooLigbGPcyhOCJ2sEv0ZKCt47lkhTXO+NZlQwiM8biHQSZ1NhfF3e68rRrDTemC9/u850PEW/aVteg6D0rPxWg37jMZTW9/Afkxr3yvGfVn9u5mX7+3HZvN1vNcT/SJUOLK64vk0f9zYnsMqJnF8YCVbuscSO0lHkyxcno91ld6dayHIoNNRXxGu0gvCbHtmjNVY/QsAAP//PV6J15ICAAA="
        },
        "mode": 420
      },
      {
        "path": "/usr/local/sbin/nft-close-when-tailscale.sh",
        "contents": {
          "compression": "gzip",
          "source": "data:;base64,H4sIAAAAAAAC/2yQUWvqMBSA3/Mrzs0VfWpzr69DQUYdguvAjb2MIWl6YoPxpGuSsqH+91G1w7G9Jt/5OOf7+0dE34jCkCikr5jHAAlGB7WpUUtj2Xw5u5tw0cpGWFMI0kF4X62VdR5LzrL8eb5YZhMuMCgRpLFeSYtJ6ba1dR8pUsvZ7UP+NFvk2Wqdz+6zCf/COHuBRAMfXDQcXmE4BO9io/Dquce6ZS4MvpsA/5hyu52kEpIWSqe22MBUlNgKitbCeDr8D4dDzxrdM4Z8jSp00tF+nz4GGTBdRSJDm+NxBHzwfWUO4yvtATYN1pC8QWgi3kCokBiAqjvfqQPpIAuLPj1nSpWjHz+ONAM45fddf9Lhl/kzFVxUVX8/04ZdLvoMAAD//xmk2Y+/AQAA"
        },
        "mode": 493
      },
      {
        "path": "/etc/tailscale-dokploy.env",
        "contents": {
          "compression": "",
          "source": "data:,CONTAINER_NAME%3D%22tailscale%22%0A"
        },
        "mode": 420
      },
      {
        "path": "/etc/systemd/journald.conf.d/10-persistent-limited.conf",
        "contents": {
          "compression": "",
          "source": "data:,%5BJournal%5D%0AStorage%3Dpersistent%0ASystemMaxUse%3D250M%0ARuntimeMaxUse%3D100M%0ACompress%3Dyes%0A"
        },
        "mode": 420
      },
      {
        "overwrite": true,
        "path": "/etc/systemd/timesyncd.conf",
        "contents": {
          "compression": "",
          "source": "data:,%5BTime%5D%0ANTP%3Da.st1.ntp.br%20b.st1.ntp.br%0AFallbackNTP%3D0.pool.ntp.org%201.pool.ntp.org%0A"
        },
        "mode": 420
      },
      {
        "path": "/etc/timezone",
        "contents": {
          "compression": "",
          "source": "data:,America%2FSao_Paulo"
        },
        "mode": 420
      },
      {
        "path": "/etc/systemd/resolved.conf.d/10-dns.conf",
        "contents": {
          "compression": "",
          "source": "data:,%5BResolve%5D%0ADNS%3D1.1.1.1%208.8.8.8%0AFallbackDNS%3D9.9.9.9%0ACache%3Dyes%0ADNSStubListener%3Dyes%0A"
        },
        "mode": 420
      },
      {
        "path": "/etc/docker/daemon.json",
        "contents": {
          "compression": "gzip",
          "source": "data:;base64,H4sIAAAAAAAC/zTNMQ6CUBAE0J5TbLbmGy1sSDyJsUAYyRrgk92FoIS7G/jSzrzJLBkRt7EJtcoE5YL4bbEPL2nB+VHGwY0LWoi7cg4mX2zwcu44T9HOC+Ir07qvMKM6ZnfuS5cJp6rROA7p6WYfc3Q1P3Yvg5fPFht3HZGeZUJQmEfFP8/W7BcAAP//ON+24rIAAAA="
        },
        "mode": 420
      },
      {
        "path": "/etc/systemd/system/docker.service.d/10-limits.conf",
        "contents": {
          "compression": "",
          "source": "data:,%5BService%5D%0ALimitNOFILE%3D1048576%0A"
        },
        "mode": 420
      },
      {
        "path": "/etc/locksmith/config.json",
        "contents": {
          "compression": "gzip",
          "source": "data:;base64,H4sIAAAAAAAC/6rmUlBQKkpNys8viS8uKUosSU2vVLKCCSnpIEmXZ+al5JfHF5ckFpWAlBgYWxkYYFORk5qXXpIBUmKUocRVywUIAAD//9Ud77JkAAAA"
        },
        "mode": 420
      },
      {
        "path": "/etc/audit/rules.d/99-base.rules",
        "contents": {
          "compression": "gzip",
          "source": "data:;base64,H4sIAAAAAAAC/3zMTQoDIQxA4f2cIhcYAr1QCcbRMMGI0UpvX1roDxRcvN3H2ydg7AEruU+GvcIk2E8QjqVLv29v4JnY5gKkZqOuBoMtNl8Jz8/4Gqwckr7SPb/QjRqqJVTyrvYD1JIU/5g2Ch4kqhZO/FcRLtsjAAD//wj/Ftn4AAAA"
        },
        "mode": 416
      },
      {
        "path": "/usr/local/sbin/gen-internal-cert.sh",
        "contents": {
          "compression": "gzip",
          "source": "data:;base64,H4sIAAAAAAAC/4SQQU86MRDF7/0U8+/fcLLbBQMEkh50JZFggAAeiHoYyiCVbndtuwrf3qxsSDx5eYeX997kN///ySp4uTFObjDsWaAIgqoCSlPSDo1l2WKluKSoZQhW2kKj1eRjkMZF8g5ton3kbDJa/xE70ImzZxA74FfZYsXhFVotaIzJaN0YdDQRUlaU5EKwQLpEjzkIhzlB6U1OnW7vsw3ijdyBTiBcUVQRRC3nnUvX0weIYzcdgHD0BaKON6fEFk8BbgZ9EGGPnW4PXhiACNXmHbjM1N1CLldqOZePtczUA5LRhSc5e1Jjt/Mos6m6oP3g8vMEbrd0jMDrKdLx1sYp5qTup8vh7/z1eD5sd/pJmqRJuymfIervsO8AAAD///3HurOaAQAA"
        },
        "mode": 493
      },
      {
        "path": "/etc/systemd/system/swapfile-create.service",
        "contents": {
          "compression": "gzip",
          "source": "data:;base64,H4sIAAAAAAAC/1SOsU7DQBBE+/uKpUkq49DQXQFxhOiQAqKwXKzPe3jFec+6XUPy98iFQZTz9DQz7Zuwda4hDYVn4yz+WAiNQL9xjpwIOAL2SmLumGXg1XlBG08XVlN/U2+iayjikqyhmWQgCUzqJbuHaFR8ygFTFfXWsHyQufZM5YsDde71OpPPQjpmc6cLhbNhMV8vWuqepe5RR6gC7COmtcUIqgR3T/C7DLsdhHHKA9wfDv/x9LmmP7Z37bOoYUqde0cxGh6vflqScbUole3dTwAAAP//dOBZNBcBAAA="
        },
        "mode": 420
      },
      {
        "path": "/etc/systemd/system/swapfile.swap",
        "contents": {
          "compression": "gzip",
          "source": "data:;base64,H4sIAAAAAAAC/3TMMa7CQAxF0d6r+BtI/gqmCKKhBaEUUQpreAFLwxDsl0Tsngo62nulM5yrcZQ9IrvNtEdNXaatSvzFpvNkBXLEczFHpE9pskOJNuCrZUg3Ef7zDqdN51H6mzL9f9HhUINayii9VuKye6X7UmjNEvCW6ldQ3gEAAP//nTPw2Z8AAAA="
        },
        "mode": 420
      }
    ]
  },
  "systemd": {
    "units": [
      {
        "contents": "[Unit]\nDescription=Disable SMT at runtime on first boot (fallback)\nConditionPathExists=!/var/lib/smt_fallback_done\nAfter=multi-user.target\n[Service]\nType=oneshot\nExecStart=/usr/bin/bash -c 'test -e /sys/devices/system/cpu/smt/control \u0026\u0026 echo off \u003e /sys/devices/system/cpu/smt/control || true; touch /var/lib/smt_fallback_done'\n[Install]\nWantedBy=multi-user.target\n",
        "enabled": true,
        "name": "smt-fallback-firstboot.service"
      },
      {
        "contents": "[Unit]\nDescription=Set system timezone from /etc/timezone\nBefore=sshd.service\n[Service]\nType=oneshot\nExecStart=/usr/bin/timedatectl set-timezone $(cat /etc/timezone)\n[Install]\nWantedBy=multi-user.target\n",
        "enabled": true,
        "name": "set-timezone.service"
      },
      {
        "enabled": true,
        "name": "systemd-resolved.service"
      },
      {
        "contents": "[Unit]\nDescription=Apply nftables rules (Flatcar)\nAfter=network-online.target\nWants=network-online.target\n[Service]\nType=oneshot\nExecStart=/usr/sbin/nft -f /etc/nftables.conf\nRemainAfterExit=yes\n[Install]\nWantedBy=multi-user.target\n",
        "enabled": true,
        "name": "nft-apply.service"
      },
      {
        "dropins": [
          {
            "contents": "[Unit]\nAfter=nft-apply.service\nWants=nft-apply.service\n",
            "name": "10-firewall-order.conf"
          }
        ],
        "name": "sshd.service"
      },
      {
        "enabled": true,
        "name": "docker.service"
      },
      {
        "enabled": true,
        "name": "docker.socket"
      },
      {
        "contents": "[Unit]\nDescription=Switch nftables to CLOSED profile when Tailscale container is up\n[Service]\nType=oneshot\nExecStart=/usr/local/sbin/nft-close-when-tailscale.sh\n",
        "name": "nft-close-ssh.service"
      },
      {
        "contents": "[Unit]\nDescription=Timer to close public SSH when Tailscale is running\n[Timer]\nOnBootSec=45s\nOnUnitInactiveSec=2m\nAccuracySec=30s\nUnit=nft-close-ssh.service\n[Install]\nWantedBy=timers.target\n",
        "enabled": true,
        "name": "nft-close-ssh.timer"
      },
      {
        "enabled": true,
        "name": "update-engine.service"
      },
      {
        "enabled": true,
        "name": "locksmithd.service"
      },
      {
        "contents": "[Unit]\nDescription=Apply Linux audit rules if auditctl exists\nAfter=multi-user.target\n[Service]\nType=oneshot\nExecStart=/usr/bin/bash -c 'command -v auditctl \u003e/dev/null 2\u003e\u00261 \u0026\u0026 auditctl -R /etc/audit/rules.d/99-base.rules || true'\n[Install]\nWantedBy=multi-user.target\n",
        "enabled": true,
        "name": "audit-rules-apply.service"
      },
      {
        "contents": "[Unit]\nDescription=Generate internal self-signed certificate (one-shot)\nAfter=network-online.target\n[Service]\nType=oneshot\nExecStart=/usr/local/sbin/gen-internal-cert.sh\n[Install]\nWantedBy=multi-user.target\n",
        "enabled": true,
        "name": "gen-internal-cert.service"
      },
      {
        "enabled": true,
        "name": "swapfile-create.service"
      },
      {
        "enabled": true,
        "name": "swapfile.swap"
      }
    ]
  }
}
