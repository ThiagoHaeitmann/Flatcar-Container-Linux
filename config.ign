{
  "ignition": {
    "version": "3.3.0"
  },
  "kernelArguments": {
    "shouldExist": [
      "mitigations=auto,nosmt",
      "tsx=auto"
    ]
  },
  "passwd": {
    "users": [
      {
        "groups": [
          "sudo"
        ],
        "name": "core",
        "passwordHash": "!",
        "sshAuthorizedKeys": [
          "ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIKGwL0d8tr2Ih4GUTXaJRoQXFxXoMlsNtB1yZv52Q7oi ceo@haeicore.com.br"
        ]
      }
    ]
  },
  "storage": {
    "directories": [
      {
        "path": "/var/log/journal",
        "mode": 493
      },
      {
        "path": "/var/lib/nft",
        "mode": 493
      },
      {
        "path": "/etc/ssl/localcerts",
        "mode": 493
      },
      {
        "path": "/etc/systemd/resolved.conf.d",
        "mode": 493
      },
      {
        "path": "/etc/local-scripts",
        "mode": 493
      }
    ],
    "files": [
      {
        "path": "/etc/ssh/sshd_config.d/10-hardening.conf",
        "contents": {
          "compression": "gzip",
          "source": "data:;base64,H4sIAAAAAAAC/1yQwW7bMAyG73oKPUDcxjLkYT3V7bINaLIVTTrsqsiEJdQWDZJO4rcv7AJt3Zv48RP5S49AXZQnRNliE5NOqB4d8xmprgYJkCR6JxHfOsPxBcYvfARWS7QDCViz7odjG/0LjGrnLpNyoAisi6nciyMZetbmpljfWDVv/0XOwyF2oIu1ekv2zECbdIqEqYMkU4oHuFRtgxQldKz9QCcw1ubfMw7O2PK2jUfmcIXUrDgJDf23Mr+8GzY3t9hDmhSPnbqPfQBi7YPzwZl11mM75sXafrZWDtjYMmt8t7i8q+5Zh875eXdmc5OBLJTVR3ca8KWrfiPLA4yf3sMcMqjnuCti9z74ozC2VFXb4rlqIMlPpLOjOqZm+puZH3y/pP/zfAmeGX782U+nLTZbOEGr/22e7v7uN+rOpQSkr0H8dWQe4CqBqNcAAAD//1sRzsQnAgAA"
        },
        "mode": 420
      },
      {
        "path": "/etc/issue.net",
        "contents": {
          "compression": "gzip",
          "source": "data:;base64,H4sIAAAAAAAC/1KmBHApK0CBo7NrcLC/QpBrcEiQZ4i/nkKIv4ujgmOIZ5ini6OLq8LhTgVffz/PEP8gRxdHPYgeZS7KLAcEAAD//5ZcZtW7AAAA"
        },
        "mode": 420
      },
      {
        "path": "/etc/sysctl.d/99-hardening.conf",
        "contents": {
          "compression": "gzip",
          "source": "data:;base64,H4sIAAAAAAAC/4ySTW7rMAyE9z6M4Dh5ednoLAJL0QlhWRJIOo1vX6hA84M2bbYznz4MCGUyx/W8c4Y16JqxlIlJ/aa7Nljy6CAlJzWMnIzkWxtphCXZL0R7D4hULQhFFkJT3z/RPAf3r9j2r9rutinl+MKyP7BmSuUYZhBjyA9nbAeWETfb7X+/6SaSTMlN1SQIqQmj+eErjjPp8ZZf8SVX4TMnOlIMi5JkDZhKJt9fjXQhDKlADJEV3hLF2/sVZnDVBJCCYqnkh25UV6UYoVEMJ5CYOE9t+UOh63yX68IxxGWuze/7FnEuxuPqZrh8LgvvYHgi9f+G3XA4/IhwVoOM7bv1w677CAAA//8Pna7VjAIAAA=="
        },
        "mode": 420
      },
      {
        "path": "/etc/nftables.mgmt-ports.conf",
        "contents": {
          "compression": "gzip",
          "source": "data:;base64,H4sIAAAAAAAC/ySNMYuDQBBGe3/FgM0dWOytjRZTXSApUgiml0XHZGPWldmREEL+e9BpHl/zvTfQ6GeCcA3SSb90S2RJgPAGawuoTW0KKI3Z+LexMtXObdfK0pbwyXKwFtv2pCdsOAaSG61J/3hkN7rZqQfPcfIqw0Oclkd8FVm+a/Gf43NoqYcfd1+T0K+GsIkszs/EmsQLOxr9BIGEfZ+ybwAAAP//fPxWacoAAAA="
        },
        "mode": 420
      },
      {
        "path": "/etc/nftables.conf",
        "contents": {
          "compression": "gzip",
          "source": "data:;base64,H4sIAAAAAAAC/5RTwW7TQBC9+yueDIdUtE0oVYXoB8C9SByr9XocD13vrHbHcaIoX9MTZ25c82PIdtwmAQ745J03s/N23pvKtalGbB0l0oy9dW1JyOekdu4rNYWjdN0sG70KEjVdW/FVnmUDAPakqNgpRWwzwNaGPdiHVoczoJtAU0Yt8nQAQ2SJrBss7hHEsd2gjBLuhxqrSGqUQKlvw6mm8jKSM0oljLUUdMhjruBkioyhgBBFxYoD2yacpIc7eFprXcYBW92dlL7Bw8MXhP2vwrGV/poVp/3PyIKZ0f0PfDXskjWOkNqC48X4PhtQ9pPBzc0rcU8dHDesiP3x/WLesG+Vzhp+pqT7Z/mEJA15JazYHLWZsVeKlbGEICXB758FtOakHOEFhYheTJPwpiHkOhUv8iNqb3v9HtWGx0HDMxbfqHh59tmbth8Xl7e3H3YnFZG+k1V0rPUwx/Uosikb9lchSs0FK5UZsBsLXr/RH5XEzsTyXw6Z4COPHJga56Q7dsV8ckWkFMQnSv9loOlGK14Ne4oJKohkbA2te3srxd7is1LsE0UUkcslwfgSqTOxOQRORdgiH9MX+eX0+7jsxtQ+VMSrdzl2p0xmEpTFG3dxICUris5s4Ek7iU8JXKFNw1yPBF+tnfHX1vTi5ac39gsFWlHcaM1+CXKJBuhs4XYviyut9suJ7Z+iTNBfFndseo9dtst+BwAA///v0/SDTgQAAA=="
        },
        "mode": 420
      },
      {
        "path": "/etc/nftables.closed.conf",
        "contents": {
          "compression": "gzip",
          "source": "data:;base64,H4sIAAAAAAAC/5STz27TQBDG736KT4ZDK9o6ElWF1CtSOXCoVCSO1WY9joesd1azk6RRlKfhEbhx7Ysh23FJChzwyZ4/u+Pv900TVrmFrgJlsoKjD6uaUFZkvoqNuXmgfNUtOrtMopavvMSmLIohAY5kaDgYKXYF4FvHERzTyoZvwLaJpopWZHlIJmVRti1mt0gS2G9Rq6TboccbsjkjUO6v4dxSfaEUnFEN5z0lG+qYGwSZImMoIamYeAlg36WT8nSDSE/W1jrk1jcnrW9wR9mevwvOHh4+VfcqXXWnrnHRVZ9lydVHWaYg2+pe1BxH0nPk5x9Ys8MXxyF7F2iaK7qOUNoUnpUwn1D3EuJtr+aj+fQ4KPpqiK80R3r+OQ/sZVTwpXH3YXZxff1+f9Kh9I28YcPWDn/1NEru6o7jZVJpec5GdQHsx4bfz0irEd04rf/Fa0ofETtM6kKQzTGjamKklJPETPm/cE4neomjvhkmUHK+hbW92Yy0N9xZLX5JirlyvSC4WCNvnHaHwPkJhB3KsXxWXkyvj4vNWNqH5nr5rsT+dJIzScYSXTg/DCVr0uC2iGQb0WUGN1jlQdcj4Oun4OKVdz288vTE3t6gNenWWo4LUMijW17Zf/+yRrKyflWw+xPKlPrLGo2X3mJf7ItfAQAA//9rPugi3AMAAA=="
        },
        "mode": 420
      },
      {
        "path": "/etc/nftables.open.conf",
        "contents": {
          "compression": "gzip",
          "source": "data:;base64,H4sIAAAAAAAC/5RTzY7bPAy8+ykIf99hF81ft4tFgTxMoEh0zEYWBYqOEwR+98Jy3Njb9tCcIs2QGs+QlW9TDdJ6TKgFBetbh1BuUe02VGqOHtOmOTW6jiyaNpZDVRZFBoACKlTkFQXuBYCtDQWgEFvNZwC9RZwYNfP5AUYhFtIb7PYQ2ZO9gROO+1xjFZIaRcA0PEOpRrcS9EbRgbEWo2YeUQWeFzcRorCyZQ9km7jEPiDgVWsnGbt8TOgo1EZwwyfC29tTQcAOPDWkIMPx627bUGgVP8kIpkEo1ZBP1njclbN2/w/mHdTGQzZwXvkk3b/vVu/v3/qFJMEfaBU60jorvo5uGtdQWEfhmo6k6AqAfix4/sYgKpbOiPtbFBM8CyMT/wPjPXdz+7eT/YIpckiY/impqaPloIYCSgJlEDS2Bq2HOVKUYZZeHNszChyF3AnBBAepM9I8Ll4Xht+hHOm7cjX9PZy6kTpcHWX9pYR+qeSFoxIH418foviC4s0NAmrHck5AFbQp+zoL93L1Jmys8WS5XHYcJhfwgnLTmsIJ0CfM0KfJ7n9tCLc6bAHcfw9lgv6wIeOje+iLvvgZAAD//9Mh+FW3AwAA"
        },
        "mode": 420
      },
      {
        "path": "/etc/local-scripts/nft-close-when-tailscale.sh",
        "contents": {
          "compression": "gzip",
          "source": "data:;base64,H4sIAAAAAAAC/2yQUWvCMBRG3/Mr7jLRpzabr0NBRh2C68CNvYwhaXpjg/Gma5Kyof734bTi2F6Tw+G75/pKRN+IwpAopK+YxwAJRge1qVFLY9l0PnkYcdHKRlhTCNJBeF8tlXUeS86y/HU6m2cjLjAoEaSxXkmLSenWtXVfKVLL2f1T/jKZ5dlimU8esxE/Y5y9QaKB904aDu/Q74N3sVF48dxhhzEnBj9NgBum3GYjqYSkhdKpNTYwFiW2gqK1MBz3b2G361ijO8aQr1GFg3Sw3abPQQZMF5HI0Gq/HwDv/Z7MYXih3cGqwRqSDwhNxDsIFRIDUPXB99OBdJCFRZ8eM6XK0Z8fR5oBnPMjtUA6/KM4gsFFVXUJmDbsdNR3AAAA//+nCCCAwgEAAA=="
        },
        "mode": 493
      },
      {
        "path": "/etc/tailscale-dokploy.env",
        "contents": {
          "compression": "",
          "source": "data:,CONTAINER_NAME%3D%22tailscale%22%0A"
        },
        "mode": 420
      },
      {
        "path": "/etc/systemd/journald.conf.d/10-persistent-limited.conf",
        "contents": {
          "compression": "",
          "source": "data:,%5BJournal%5D%0AStorage%3Dpersistent%0ASystemMaxUse%3D250M%0ARuntimeMaxUse%3D100M%0ACompress%3Dyes%0A"
        },
        "mode": 420
      },
      {
        "overwrite": true,
        "path": "/etc/systemd/timesyncd.conf",
        "contents": {
          "compression": "",
          "source": "data:,%5BTime%5D%0ANTP%3Da.st1.ntp.br%20b.st1.ntp.br%0AFallbackNTP%3D0.pool.ntp.org%201.pool.ntp.org%0A"
        },
        "mode": 420
      },
      {
        "path": "/etc/systemd/resolved.conf.d/10-dns.conf",
        "contents": {
          "compression": "",
          "source": "data:,%5BResolve%5D%0ADNS%3D1.1.1.1%208.8.8.8%0AFallbackDNS%3D9.9.9.9%0ACache%3Dyes%0ADNSStubListener%3Dyes%0A"
        },
        "mode": 420
      },
      {
        "path": "/etc/docker/daemon.json",
        "contents": {
          "compression": "gzip",
          "source": "data:;base64,H4sIAAAAAAAC/zTNMQ6CUBAE0J5TbLbmGy1sSDyJsUAYyRrgk92FoIS7G/jSzrzJLBkRt7EJtcoE5YL4bbEPL2nB+VHGwY0LWoi7cg4mX2zwcu44T9HOC+Ir07qvMKM6ZnfuS5cJp6rROA7p6WYfc3Q1P3Yvg5fPFht3HZGeZUJQmEfFP8/W7BcAAP//ON+24rIAAAA="
        },
        "mode": 420
      },
      {
        "path": "/etc/systemd/system/docker.service.d/10-limits.conf",
        "contents": {
          "compression": "",
          "source": "data:,%5BService%5D%0ALimitNOFILE%3D1048576%0A"
        },
        "mode": 420
      },
      {
        "path": "/etc/locksmith/config.json",
        "contents": {
          "compression": "gzip",
          "source": "data:;base64,H4sIAAAAAAAC/6rmUlBQKkpNys8viS8uKUosSU2vVLKCCSnpIEmXZ+al5JfHF5ckFpWAlBgYWxkYYFORk5qXXpIBUmKUocRVywUIAAD//9Ud77JkAAAA"
        },
        "mode": 420
      },
      {
        "path": "/etc/audit/rules.d/99-base.rules",
        "contents": {
          "compression": "gzip",
          "source": "data:;base64,H4sIAAAAAAAC/3zMTQoDIQxA4f2cIhcYAr1QCcbRMMGI0UpvX1roDxRcvN3H2ydg7AEruU+GvcIk2E8QjqVLv29v4JnY5gKkZqOuBoMtNl8Jz8/4Gqwckr7SPb/QjRqqJVTyrvYD1JIU/5g2Ch4kqhZO/FcRLtsjAAD//wj/Ftn4AAAA"
        },
        "mode": 416
      },
      {
        "path": "/etc/local-scripts/gen-internal-cert.sh",
        "contents": {
          "compression": "gzip",
          "source": "data:;base64,H4sIAAAAAAAC/4SQQU86MRDF7/0U8+/fcLLbBQMEkh50JZFggAAeiHoYyiCVbndtuwrf3qxsSDx5eYeX997kN///ySp4uTFObjDsWaAIgqoCSlPSDo1l2WKluKSoZQhW2kKj1eRjkMZF8g5ton3kbDJa/xE70ImzZxA74FfZYsXhFVotaIzJaN0YdDQRUlaU5EKwQLpEjzkIhzlB6U1OnW7vsw3ijdyBTiBcUVQRRC3nnUvX0weIYzcdgHD0BaKON6fEFk8BbgZ9EGGPnW4PXhiACNXmHbjM1N1CLldqOZePtczUA5LRhSc5e1Jjt/Mos6m6oP3g8vMEbrd0jMDrKdLx1sYp5qTup8vh7/z1eD5sd/pJmqRJuymfIervsO8AAAD///3HurOaAQAA"
        },
        "mode": 493
      },
      {
        "path": "/etc/systemd/system/swapfile-create.service",
        "contents": {
          "compression": "gzip",
          "source": "data:;base64,H4sIAAAAAAAC/1SOsU7DQBBE+/uKpUkq49DQXQFxhOiQAqKwXKzPe3jFec+6XUPy98iFQZTz9DQz7Zuwda4hDYVn4yz+WAiNQL9xjpwIOAL2SmLumGXg1XlBG08XVlN/U2+iayjikqyhmWQgCUzqJbuHaFR8ygFTFfXWsHyQufZM5YsDde71OpPPQjpmc6cLhbNhMV8vWuqepe5RR6gC7COmtcUIqgR3T/C7DLsdhHHKA9wfDv/x9LmmP7Z37bOoYUqde0cxGh6vflqScbUole3dTwAAAP//dOBZNBcBAAA="
        },
        "mode": 420
      },
      {
        "path": "/etc/systemd/system/swapfile.swap",
        "contents": {
          "compression": "gzip",
          "source": "data:;base64,H4sIAAAAAAAC/3TMMa7CQAxF0d6r+BtI/gqmCKKhBaEUUQpreAFLwxDsl0Tsngo62nulM5yrcZQ9IrvNtEdNXaatSvzFpvNkBXLEczFHpE9pskOJNuCrZUg3Ef7zDqdN51H6mzL9f9HhUINayii9VuKye6X7UmjNEvCW6ldQ3gEAAP//nTPw2Z8AAAA="
        },
        "mode": 420
      }
    ]
  },
  "systemd": {
    "units": [
      {
        "contents": "[Unit]\nDescription=Disable SMT at runtime on first boot (fallback)\nConditionPathExists=!/var/lib/smt_fallback_done\nAfter=multi-user.target\n[Service]\nType=oneshot\nExecStart=/usr/bin/bash -c 'test -e /sys/devices/system/cpu/smt/control \u0026\u0026 echo off \u003e /sys/devices/system/cpu/smt/control || true; touch /var/lib/smt_fallback_done'\n[Install]\nWantedBy=multi-user.target\n",
        "enabled": true,
        "name": "smt-fallback-firstboot.service"
      },
      {
        "contents": "[Unit]\nDescription=Set system timezone\nBefore=sshd.service\n[Service]\nType=oneshot\nExecStart=/usr/bin/timedatectl set-timezone America/Sao_Paulo\n[Install]\nWantedBy=multi-user.target\n",
        "enabled": true,
        "name": "set-timezone.service"
      },
      {
        "enabled": true,
        "name": "systemd-resolved.service"
      },
      {
        "contents": "[Unit]\nDescription=Apply nftables rules (Flatcar)\nAfter=network-online.target\nWants=network-online.target\n[Service]\nType=oneshot\nExecStart=/usr/bin/env nft -f /etc/nftables.conf\nRemainAfterExit=yes\n[Install]\nWantedBy=multi-user.target\n",
        "enabled": true,
        "name": "nft-apply.service"
      },
      {
        "dropins": [
          {
            "contents": "[Unit]\nAfter=nft-apply.service\nWants=nft-apply.service\n",
            "name": "10-firewall-order.conf"
          }
        ],
        "name": "sshd.service"
      },
      {
        "enabled": true,
        "name": "docker.service"
      },
      {
        "enabled": true,
        "name": "docker.socket"
      },
      {
        "contents": "[Unit]\nDescription=Switch nftables to CLOSED profile when Tailscale container is up\n[Service]\nType=oneshot\nExecStart=/etc/local-scripts/nft-close-when-tailscale.sh\n",
        "name": "nft-close-ssh.service"
      },
      {
        "contents": "[Unit]\nDescription=Timer to close public SSH when Tailscale is running\n[Timer]\nOnBootSec=45s\nOnUnitInactiveSec=2m\nAccuracySec=30s\nUnit=nft-close-ssh.service\n[Install]\nWantedBy=timers.target\n",
        "enabled": true,
        "name": "nft-close-ssh.timer"
      },
      {
        "enabled": true,
        "name": "update-engine.service"
      },
      {
        "enabled": true,
        "name": "locksmithd.service"
      },
      {
        "contents": "[Unit]\nDescription=Apply Linux audit rules if auditctl exists\nAfter=multi-user.target\n[Service]\nType=oneshot\nExecStart=/usr/bin/bash -c 'command -v auditctl \u003e/dev/null 2\u003e\u00261 \u0026\u0026 auditctl -R /etc/audit/rules.d/99-base.rules || true'\n[Install]\nWantedBy=multi-user.target\n",
        "enabled": true,
        "name": "audit-rules-apply.service"
      },
      {
        "contents": "[Unit]\nDescription=Generate internal self-signed certificate (one-shot)\nAfter=network-online.target\n[Service]\nType=oneshot\nExecStart=/etc/local-scripts/gen-internal-cert.sh\n[Install]\nWantedBy=multi-user.target\n",
        "enabled": true,
        "name": "gen-internal-cert.service"
      },
      {
        "enabled": true,
        "name": "swapfile-create.service"
      },
      {
        "enabled": true,
        "name": "swapfile.swap"
      }
    ]
  }
}
